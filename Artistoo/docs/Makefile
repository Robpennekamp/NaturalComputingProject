.SECONDARY:
.DELETE_ON_ERROR:


all : web-all

autoOut=ast badge.svg class converter converter.html coverage.json css examples examples.html explorables explorables.html file identifiers.html image index.html index.json layout.html lint.json log.txt manual restart script source.html test-file test.html typedef variable

clean : 
	@rm -rf $(autoOut)

restart :
	touch $@

# Step 1 : Build main site with mustache

../mustache-web/public/layout.html : restart
	@echo "		Building mustache website" && cd ../mustache-web && $(MAKE)

progress :
	@mkdir -p $@

progress/step1 : ../mustache-web/public/layout.html | progress
	@touch $@

# Step 2 : Port mustache-generated layout to mytemplate
../esdoc-template-artistoo/layout.html : ../mustache-web/public/layout.html progress/step1
	@echo "		Updating esdoc template with layout.html from mustache" && cp $< $@

progress/step2 : ../esdoc-template-artistoo/layout.html | progress
	@touch $@

# Step 3 : Auto-build documentation with esdoc; this contains:
#	- "Documentation"
#	- "Source"
#	- "Tests"
#	- link to github
#	- search index of all the auto-generated pages.
progress/step3 : progress/step2 | css
		@echo "		Updating esdoc docs" && \
		cd .. && $(MAKE) esdocs/index.html && \
		cp esdoc-template-artistoo/css/* docs/css/ && cd docs && touch $@

css : 
	mkdir -p $@

# Step 4: copy all esdoc stuff into this folder:
progress/step4 : progress/step3
	@echo "		Copying esdoc docs" && cp -r ../esdocs/* . && touch $@
	

# Step 5: add mustache-generated stuff (which includes an index.html to overwrite
# the one generated by esdoc, so this step should come after copying the esdoc stuff.)
progress/step5 : progress/step2 progress/step4
	@echo "		Adding mustache pages" && cp -r ../mustache-web/public/* . && touch $@
	

# Step 6: add extra files such as examples and manual assets
converter-files :	$(wildcard ../mustache-web/sources/converter/**/*) progress/step3
	@echo "		Adding converter pages" && cp -r ../mustache-web/sources/converter .
	
examples :
	@mkdir -p $@
	
explorables :
	@mkdir -p $@

example-files : $(wildcard ../examples/html/**/*) progress/step5 | examples
	@echo "		Adding example html files" && cp ../examples/html/* examples/ && \
	cp ../examples/3D/cpm3d.html examples/ && \
	cp ../examples/3D/Canvas3D.js examples/ && \
	cp ../examples/3D/OrbitControls.js examples/
	
manual-asset : ../mustache-web/sources/manual/asset progress/step5 converter-files
	@echo "		Adding manual asset files" &&  rm -rf manual/asset && cp -r $< manual/asset
	
explorable-asset : ../mustache-web/sources/explorable-assets progress/step5
	@echo "		Adding explorable asset files" &&  rm -rf explorables/asset && cp -r $< explorables/asset

image/examples : 
	mkdir -p $@

image/general:
	mkdir -p $@

images-examples : $(wildcard ../mustache-web/sources/images/examples/*) progress/step4 | image/examples
	@echo "		Copying example images" && cp -r ../mustache-web/sources/images/examples/* image/examples/

images-general : $(wildcard ../mustache-web/sources/images/general/*) progress/step4 | image/general
	@echo "		Copying general images" && cp -r ../mustache-web/sources/images/general/* image/general/
	

progress/step6 : converter-files example-files manual-asset explorable-asset images-examples images-general
	@touch $@


web-all : progress/step5 progress/step6
	@echo "Done!" && touch restart && rm -rf progress
